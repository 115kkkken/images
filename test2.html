<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>勝者為王 - 牌組構築器</title>
  <style>
    :root{
      --topbar-height:64px;
      --accent:#7dd3fc;
      --bg:#0b0b0b;
      --panel: rgba(255,255,255,0.03);
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#eee;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",Arial;}
    .topbar{
      position:fixed; left:0; right:0; top:0; height:var(--topbar-height);
      display:flex; align-items:center; justify-content:center; gap:22px;
      background:linear-gradient(180deg, rgba(0,0,0,0.9), rgba(0,0,0,0.75));
      border-bottom:1px solid rgba(255,255,255,0.04); z-index:999;
      padding:8px 14px; box-sizing:border-box;
    }
    .topbar .label{font-size:13px; color:#cdd; opacity:.9; margin-right:6px;}
    .topbar .value{font-weight:700; color:var(--accent); min-width:36px; text-align:right;}
    .container{max-width:1100px;margin: calc(var(--topbar-height) + 16px) auto 60px; padding:0 16px; box-sizing:border-box;}
    h1{font-size:18px;text-align:center;margin:6px 0;}
    .subtitle{opacity:.85;text-align:center;margin-bottom:10px;font-size:13px;}
    .stage-tabs{display:flex;gap:8px;justify-content:center;margin-bottom:10px;}
    .stage-tabs button{padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#ddd;cursor:pointer;}
    .stage-tabs button.active{background:var(--panel); box-shadow:0 4px 12px rgba(0,0,0,0.6); color:var(--accent);}
    .grid{display:flex;gap:16px;}
    .col{flex:1; min-width:280px;}
    .panel{background:var(--panel); border-radius:10px; padding:12px; border:1px solid rgba(255,255,255,0.04);}
    .leaders{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;}
    .leader{width:22%;min-width:140px; text-align:center; cursor:pointer; user-select:none;}
    /* 改為 contain：保持原圖比例，整張圖會被完整顯示（不裁切），並且所有圖片使用相同框尺寸 */
    /* 修改 A、B、C 卡片的圖片 */
.card-item img {
    width: 100%;
    border-radius: 6px;
    display: block;
    height: auto;        /* 從 140px 改為 auto */
    object-fit: contain; /* 從 cover 改為 contain，保證不切圖 */
}

/* 修改下方小卡片（先發陣容）的圖片 */
.sub-card img, .unit-card img {
    width: 100%;
    border-radius: 6px; 
    display: block; 
    height: auto;        /* 從 120px 改為 auto */
    object-fit: contain; 
}
    .leader img
    {
      width:100%;
      height:140px;            /* 固定顯示高度 */
      object-fit:contain;      /* preserve aspect ratio, no cropping */
      object-position:center;
      border-radius:8px;
      display:block;
      background:#000;         /* 黑底避免透明或白邊突兀 */
      padding:6px;             /* 給 contain 時的「留白」一點間距，使視覺與領主一致 */
      box-sizing: border-box;
    }
    .leader .label{margin-top:6px;font-weight:600;color:#ddd;}
    .leader.selected img{border-color:var(--accent); box-shadow:0 0 12px rgba(125,211,252,0.08);}
    .section-title{font-weight:700;margin-bottom:8px;color:#cfe8ff;}
    .card-list{display:flex;flex-wrap:wrap;gap:10px;}
    .card-item{width:calc(33.333% - 8px); min-width:140px; background:rgba(255,255,255,0.02); padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); box-sizing:border-box;}
    .card-meta{display:flex;justify-content:space-between;align-items:center;margin-top:6px;font-size:13px;}
    .card-meta .small{opacity:.9;}
    .card-controls{display:flex;align-items:center;gap:8px;margin-top:8px;justify-content:center;}
    .card-controls button{padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--accent);cursor:pointer;}
    .card-controls input[type="checkbox"]{transform:scale(1.1);}
    .sub-gallery{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;justify-content:center;}
    .sub-card{width:calc(20% - 12px);min-width:140px;background:rgba(255,255,255,0.02);border-radius:8px;padding:8px;box-sizing:border-box;border:1px solid rgba(255,255,255,0.03);}
    .card-cost{color:#9ae6b4;font-weight:700;margin-top:6px;}
    .card-max{margin-top:4px;color:#cfe8ff;opacity:.9;font-size:13px;}
    .count{min-width:36px;text-align:center;font-weight:700;}
    .count-controls{display:flex;align-items:center;justify-content:center;gap:8px;margin-top:8px;}
    .count-controls button{width:34px;height:34px;border-radius:6px;border:1px solid rgba(125,211,252,0.08);background:rgba(125,211,252,0.04);color:var(--accent);font-size:18px;cursor:pointer;}
    .count-controls button:disabled{opacity:.45;cursor:not-allowed;}
    .selected-units-wrap{margin-top:18px;}
    .selected-units{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-top:8px;}
    .unit-card{width:calc(20% - 12px);min-width:160px;background:rgba(255,255,255,0.02);border-radius:8px;padding:8px;box-sizing:border-box;border:1px solid rgba(255,255,255,0.03);}
    .unit-card .unit-title{font-weight:700;margin-top:6px;}
    .upgrades{display:flex;flex-direction:column;gap:6px;margin-top:8px;}
    .upgrade-btn{padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--accent);cursor:pointer;}
    .upgrade-btn.active{background:rgba(125,211,252,0.12);box-shadow:0 0 8px rgba(125,211,252,0.06);}
    .unit-actions{display:flex;gap:8px;margin-top:8px;justify-content:center;}
    .btn-small{padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--accent);cursor:pointer;}
    .footer-actions{display:flex;justify-content:center;margin-top:12px;gap:8px;}
    .btn-primary{background:var(--accent); color:#012; border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700;}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#ddd;padding:8px 12px;border-radius:8px;cursor:pointer;}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;}
    .modal{background:#071018;padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);width:90%;max-width:560px;}
    .modal h3{margin:0 0 8px 0;}
    .modal label{display:block;margin-top:8px;font-size:13px;color:#cfe8ff;}
    .modal input[type="text"], .modal textarea{width:100%;box-sizing:border-box;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#fff;}
    .hint{font-size:13px;color:#cdd;margin-top:6px;text-align:center;}
    @media (max-width:900px){ .card-item{width:calc(50% - 8px);} .sub-card{width:calc(33.333% - 12px);} .leader{width:45%;} .unit-card{width:calc(33.333% - 12px);} }
    @media (max-width:520px){ .card-item{width:100%;} .sub-card{width:calc(50% - 12px);} .leader{width:100%;} .unit-card{width:calc(50% - 12px);} }
    .flash{animation:flash 360ms ease;} @keyframes flash{0%{box-shadow:none;}40%{box-shadow:0 0 10px rgba(255,0,0,0.6);}100%{box-shadow:none;}}
  </style>
</head>
<body>

  <!-- Topbar: remaining budget + selected card total count -->
  <div class="topbar" aria-hidden="false">
    <div style="display:flex;align-items:center;gap:8px">
      <div class="label">剩餘費用</div>
      <div id="remainingBudget" class="value">20</div>
    </div>
    <div style="width:18px"></div>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="label">已選卡牌數量</div>
      <div id="selectedCount" class="value">0</div>
    </div>
    <div style="width:18px"></div>
    <div id="loadingStatus" style="color:#cfe8ff;font-size:13px;opacity:.9"></div>
  </div>

  <div class="container">
    <h1>勝者為王 - 牌組構築器</h1>

    <div class="stage-tabs" role="tablist" aria-label="階段切換">
      <button id="tabCamp" class="active">大本營牌庫</button>
      <button id="tabLineup">先發陣容</button>
    </div>

    <!-- CAMP -->
    <div id="campStage">
      <div class="panel">
        <div class="section-title">選擇領主</div>
        <div class="leaders" id="leadersList"></div>
        <div class="hint">選領主會自動把該類型的 A 卡加入大本營。可額外從其他兩類 A 卡中選 2 張。B 卡 3 張（任意）。C 卡最多選 2 種。</div>
      </div>

      <div style="height:12px;"></div>

      <div class="grid">
        <div class="col panel">
          <div class="section-title">A 卡（同領主類型自動加入 / 其他類型最多可選 2 張）</div>
          <div id="aCardsArea" class="card-list"></div>
          <div class="hint" id="aLimitHint"></div>
        </div>

        <div class="col panel">
          <div class="section-title">B 卡（任意選，現在 3 張）</div>
          <div id="bCardsArea" class="card-list"></div>
        </div>

        <div class="col panel">
          <div class="section-title">C 卡（請選擇最多 2 種）</div>
          <div id="cCardsArea" class="card-list"></div>
          <div class="hint" id="cLimitHint"></div>
        </div>
      </div>

      <div class="footer-actions">
        <button class="btn-primary" id="enterLineupBtn">建立大本營並進入先發陣容</button>
        <button class="btn-ghost" id="resetCampBtn">重置大本營</button>
      </div>
    </div>

    <!-- LINEUP -->
    <div id="lineupStage" style="display:none;">
      <div class="panel">
        <div class="section-title">先發陣容 (from 大本營)</div>
        <div id="lineupHint" class="hint">點 + 增加一個單位，並在下方為該單位選擇升級。領主會自動加入並可升級。</div>
        <div id="lineupGallery" class="sub-gallery"></div>

        <!-- Selected units area (shows chosen units bottom of page) -->
        <div class="selected-units-wrap">
          <div class="section-title" style="margin-top:12px;">已選擇的先發單位（可為單位加裝升級）</div>
          <div id="selectedUnits" class="selected-units"></div>
        </div>

      </div>

      <div class="footer-actions" style="margin-top:14px;">
        <button class="btn-primary" id="confirmBtn">確認先發陣容</button>
        <button class="btn-ghost" id="backToCampBtn">返回編輯大本營</button>
        <button class="btn-ghost" id="clearLineupBtn">重置先發構築</button>
      </div>
    </div>

  </div>

<script>
  // ---------------------------
  // Image preloading / caching
  // ---------------------------
  const imageCache = {}; // map: cardId -> Image object
  let preloadDone = false;

  async function preloadImagesForAll() {
    const items = [];
    const pushUnique = (id, img) => {
      if (!id || !img) return;
      if (!items.some(it => it.id === id)) items.push({ id, img });
    };

    leaders.forEach(l => pushUnique(l.id, l.img));
    Object.values(aCardsByType).flat().forEach(c => pushUnique(c.id, c.img));
    bCards.forEach(c => pushUnique(c.id, c.img));
    cCards.forEach(c => pushUnique(c.id, c.img));

    const statusEl = document.getElementById('loadingStatus');
    statusEl.textContent = '正在預載圖片…';
    await Promise.all(items.map(item => new Promise(resolve => {
      const img = new Image();
      img.onload = () => { imageCache[item.id] = img; resolve(); };
      img.onerror = () => { imageCache[item.id] = null; resolve(); };
      img.src = item.img;
    })));
    statusEl.textContent = '';
    preloadDone = true;
  }

  // ---------------------------
  // Helpers and data
  // ---------------------------
  const MAX_BUDGET = 20;
  let usedBudget = 0;

  const UPGRADES = [
    { key: 'atk', label: '攻擊 +2', cost: 1 },
    { key: 'move', label: '移動 +2', cost: 1 },
    { key: 'life', label: '生命 +2', cost: 1 },
    { key: 'morale', label: '士氣 +3', cost: 1 },
    { key: 'tenacity', label: '堅韌 +1', cost: 1 }
  ];

  function imgForId(id){
    return `${id.toLowerCase()}.webp`;
  }

  const leaders = [
    { id:'L_D_A', name:'惡魔 領主 A', type:'demon', img: imgForId('L_D_A') },
    { id:'L_D_B', name:'惡魔 領主 B', type:'demon', img: imgForId('L_D_B') },
    { id:'L_T_A', name:'古墓 領主 A', type:'tomb',  img: imgForId('L_T_A') },
    { id:'L_T_B', name:'古墓 領主 B', type:'tomb',  img: imgForId('L_T_B') },
    { id:'L_N_A', name:'幽冥 領主 A', type:'nether', img: imgForId('L_N_A') },
    { id:'L_N_B', name:'幽冥 領主 B', type:'nether', img: imgForId('L_N_B') }
  ];

  // (略過中間卡資料以節省篇幅 — 使用你原本的資料塊；上面示範的程式碼保留)
  const aCardsByType = {
    demon: [
      { id:'A_DE_1', name:'魔力使者', cost:8, maxCopies:2, img: imgForId('A_DE_1') },
      { id:'A_DE_2', name:'暗影勇士', cost:6, maxCopies:2, img: imgForId('A_DE_2') },
      { id:'A_DE_3', name:'淵能術者', cost:3, maxCopies:2, img: imgForId('A_DE_3') },
      { id:'A_DE_4', name:'饕餮喚靈', cost:1, maxCopies:3, img: imgForId('A_DE_4') },
      { id:'A_DE_5', name:'惡靈騎士', cost:4, maxCopies:3, img: imgForId('A_DE_5') },
      { id:'A_DE_6', name:'腐化先鋒', cost:3, maxCopies:1, img: imgForId('A_DE_6') }
    ],
    tomb: [
      { id:'A_TO_1', name:'墓園守衛', cost:3, maxCopies:3, img: imgForId('A_TO_1') },
      { id:'A_TO_2', name:'骷髏領主', cost:5, maxCopies:3, img: imgForId('A_TO_2') },
      { id:'A_TO_3', name:'腐骨弓手', cost:4, maxCopies:3, img: imgForId('A_TO_3') },
      { id:'A_TO_4', name:'陵衛戰士', cost:1, maxCopies:5, img: imgForId('A_TO_4') },
      { id:'A_TO_5', name:'古殿祭者', cost:1, maxCopies:5, img: imgForId('A_TO_5') }
    ],
    nether: [
      { id:'A_NT_1', name:'幽影獵手', cost:2, maxCopies:3, img: imgForId('A_NT_1') },
      { id:'A_NT_2', name:'冥火術士', cost:3, maxCopies:2, img: imgForId('A_NT_2') },
      { id:'A_NT_3', name:'虛無行者', cost:4, maxCopies:1, img: imgForId('A_NT_3') }
    ]
  };

  const bCards = [
    { id:'B_1', name:'戰術支援', cost:2, maxCopies:1, img: imgForId('B_1') },
    { id:'B_2', name:'補給運營', cost:9, maxCopies:1, img: imgForId('B_2') },
    { id:'B_3', name:'前線增援', cost:3, maxCopies:1, img: imgForId('B_3') }
  ];

  const cCards = Array.from({length:6}, (_,i)=>({
    id:`C_${i+1}`, name:`C 卡 ${i+1}`, cost: (i%5)+1, maxCopies: (i%4)+2,
    img: imgForId(`C_${i+1}`)
  }));

  // 其餘程式（渲染、互動、匯出等）保持你原本實作
  // 為簡潔起見我省略重複的程式碼段：render / toggle / buildCamp / export 仍與前版本相同
  // 如果你要，我可以把完整的 script（包含所有函式）再貼回一次與整合。

  // 為確保 UI 使用預載圖片（避免 CLS），在 init 時先預載再 render
  async function init(){
    document.getElementById('enterLineupBtn').disabled = true;
    document.getElementById('confirmBtn').disabled = true;
    document.getElementById('clearLineupBtn').disabled = true;
    document.getElementById('resetCampBtn').disabled = true;

    await preloadImagesForAll();

    document.getElementById('enterLineupBtn').disabled = false;
    document.getElementById('confirmBtn').disabled = false;
    document.getElementById('clearLineupBtn').disabled = false;
    document.getElementById('resetCampBtn').disabled = false;

    // 呼叫你現有的 render 函式（在本檔中應存在）
    if (typeof renderLeaders === 'function') renderLeaders();
    if (typeof renderACards === 'function') renderACards();
    if (typeof renderBCards === 'function') renderBCards();
    if (typeof renderCCards === 'function') renderCCards();
    if (typeof updateLimitHints === 'function') updateLimitHints();
  }

  // 如果你需要我把完整（未省略）腳本整個貼回去（包含已存在的 exportDeckAsImage），我可以把整個合併版提供給你。
  init();
</script>
</body>
</html>

